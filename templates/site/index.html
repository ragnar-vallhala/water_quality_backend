<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Quality Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --color-primary: #007AFF;
            --color-success: #34C759;
            --color-warning: #FF9500;
            --color-danger: #FF3B30;
        }
        body { font-family: 'Inter', sans-serif; background-color:" #f5ff5f5"; }
        .status-excellent { background-color: var(--color-success); }
        .status-good { background-color: var(--color-warning); }
        .status-fair { background-color: #FFCC00; }
        .status-poor { background-color: var(--color-danger); }
        .shadow-card { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .back-button { position: absolute; top: 1.5rem; left: 1rem; z-index: 10; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="app-container" class="pb-10">
        <!-- Header -->
        <header class="bg-white p-4 pt-10 border-b border-gray-200 shadow-sm">
            <div class="max-w-xl mx-auto relative">
                <h1 id="title" class="text-2xl font-bold text-gray-800 text-center">Water Quality Dashboard</h1>
                <h2 id="subtitle" class="text-sm text-gray-500 text-center mt-1">Unit #Loading...</h2>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="max-w-xl mx-auto px-4">
            
            <!-- 1. TDS Quality Graph with Date Filter -->
            <section class="bg-white p-0 mt-4 rounded-xl shadow-card overflow-hidden">
                <h3 class="text-lg font-bold p-4 pb-2 text-gray-700">TDS Trend Over Time</h3>
                
                <!-- Filter Bar -->
                <div class="flex justify-around p-2 border-b border-gray-100 bg-white">
                    <button data-filter="all" class="filter-button px-4 py-1 text-sm rounded-full bg-blue-500 text-white font-semibold">All Time</button>
                    <button data-filter="7days" class="filter-button px-4 py-1 text-sm rounded-full text-gray-600 hover:bg-gray-100 font-semibold">Last 7 Days</button>
                </div>
                
                <!-- Chart Container -->
                <div class="p-3">
                    <div id="chartLoading" class="text-center py-10">
                        <i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i>
                        <p class="text-gray-500 mt-2">Fetching TDS data...</p>
                    </div>
                    <canvas id="tdsChart" style="height: 220px;"></canvas>
                    <div id="chartPlaceholder" class="hidden text-center py-10 text-gray-500">
                        No data to show in graph for this range.
                    </div>
                </div>
            </section>

            <!-- 2. Maintenance History -->
            <section class="mt-5">
                <h3 class="text-xl font-bold mb-3 text-gray-700">Maintenance History</h3>
                <div id="maintenanceList" class="space-y-3">
                    <!-- Maintenance records will be injected here -->
                    <div id="loadingMaintenance" class="text-center py-5">
                        <i class="fas fa-spinner fa-spin text-xl text-yellow-600"></i>
                        <p class="text-gray-500 mt-2">Fetching maintenance records...</p>
                    </div>
                </div>
            </section>

            <!-- 3. Quality History List -->
            <section class="mt-5">
                <h3 class="text-xl font-bold mb-3 text-gray-700">TDS Reading History</h3>
                <div id="qualityList" class="space-y-3">
                    <!-- Quality records will be injected here -->
                </div>
            </section>

        </main>
    </div>

    <script>
        // --- Configuration & Global State ---
        let unitId = null;
        let qualityData = [];
        let maintenanceRecords = [];
        let currentChart = null;
        let dateFilter = 'all';

        const BASE_URL = 'http://72.60.102.111:8090'; 

        // --- Utility Functions ---

        function getQueryParams() {
            const params = new URLSearchParams(window.location.search);
            // Default to '1' if 'wu' (Water Unit ID) is missing, matching the API example
            unitId = params.get('wu') || '1'; 
            if (params.get('wu') === null) {
                console.warn("WU ID not found in URL, defaulting to '1' for API path simulation.");
            }
        }

        function getTDSStatus(tds) {
            if (tds < 50) return { status: 'Excellent', color: 'status-excellent' };
            if (tds < 150) return { status: 'Good', color: 'status-good' };
            if (tds < 300) return { status: 'Fair', color: 'status-fair' };
            return { status: 'Poor', color: 'status-poor' };
        }

        function getMaintenanceStatusColor(status) {
            switch (status?.toLowerCase()) {
                case 'completed': return 'bg-green-500';
                case 'in progress': return 'bg-yellow-500';
                case 'pending': default: return 'bg-red-500';
            }
        }

        // --- Data Fetching Functions (Using actual fetch API) ---

        async function loadWaterQuality() {
            document.getElementById('chartLoading').classList.remove('hidden');
            
            try {
                const apiUrl = `${BASE_URL}/api/water-quality/?wu=${unitId}`;
                
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                
                // Sort data (oldest first)
                qualityData = data.sort((a, b) => new Date(a.date_time).getTime() - new Date(b.date_time).getTime());
            
            } catch (error) {
                console.error('Failed to fetch water quality data:', error);
                
                // Update UI to show error
                const placeholder = document.getElementById('chartPlaceholder');
                placeholder.textContent = 'Error loading water quality data.';
                placeholder.classList.remove('hidden');
                document.getElementById('tdsChart').classList.add('hidden');
            }
            
            document.getElementById('chartLoading').classList.add('hidden');
            renderAll();
        }

        async function loadMaintenanceRecords() {
            document.getElementById('loadingMaintenance').classList.remove('hidden');
            
            try {
                const apiUrl = `${BASE_URL}/api/maintenance/?wu=${unitId}`;

                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                maintenanceRecords = data;
                
            } catch (error) {
                 console.error('Failed to fetch maintenance records:', error);
                 // Display error message in the list area
                 document.getElementById('maintenanceList').innerHTML = `
                    <p class="text-red-500 text-center p-4">Failed to load maintenance records. Check console for details.</p>
                 `;
            }
            
            document.getElementById('loadingMaintenance').classList.add('hidden');
            renderMaintenanceList();
        }

        // --- Rendering Functions ---

        function getFilteredQualityData() {
            if (dateFilter === 'all') {
                return qualityData;
            }

            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

            return qualityData.filter(record => {
                const recordDate = new Date(record.date_time);
                // Check if date is valid and is newer than or equal to 7 days ago
                return !isNaN(recordDate.getTime()) && recordDate >= sevenDaysAgo;
            });
        }

        function renderChart() {
            const filteredData = getFilteredQualityData();
            const canvas = document.getElementById('tdsChart');
            const placeholder = document.getElementById('chartPlaceholder');
            
            if (currentChart) {
                currentChart.destroy();
            }

            if (filteredData.length === 0) {
                canvas.classList.add('hidden');
                placeholder.classList.remove('hidden');
                placeholder.textContent = 'No data to show in graph for this range.';
                return;
            }

            canvas.classList.remove('hidden');
            placeholder.classList.add('hidden');

            const chartData = filteredData.map(record => record.tds);
            const chartLabels = filteredData.map(record => {
                const date = new Date(record.date_time);
                return date.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit' });
            });
            
            // Label Sampling for X-axis: show every 3rd label and the last one
            const labelSamplingFactor = 3; 
            const sampledLabels = chartLabels.map((label, index) => 
                (index % labelSamplingFactor === 0 || index === chartLabels.length - 1) 
                    ? label 
                    : ''
            );

            currentChart = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: sampledLabels,
                    datasets: [{
                        label: 'TDS (ppm)',
                        data: chartData,
                        borderColor: 'rgba(0, 122, 255, 1)',
                        backgroundColor: 'rgba(0, 122, 255, 0.1)',
                        tension: 0.3,
                        pointRadius: 4,
                        pointBackgroundColor: chartData.map(tds => {
                            // Assign color based on TDS status
                            const statusColor = getTDSStatus(tds).color;
                            if (statusColor === 'status-excellent') return '#34C759';
                            if (statusColor === 'status-good') return '#FF9500';
                            if (statusColor === 'status-fair') return '#FFCC00';
                            return '#FF3B30';
                        }),
                        pointBorderColor: '#fff',
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { autoSkip: false, maxRotation: 0, minRotation: 0 }
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'TDS (ppm)' },
                            ticks: {
                                // Y-Axis Label Fix: Show whole numbers and append 'ppm'
                                callback: function(value, index, ticks) {
                                    return `${Math.round(value)} ppm`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderMaintenanceList() {
            const listElement = document.getElementById('maintenanceList');
            // Show newest records first
            const records = maintenanceRecords.slice().reverse();

            // Only proceed if loading spinner is gone AND there are no records (to show empty state)
            if (records.length === 0 && document.getElementById('loadingMaintenance').classList.contains('hidden')) {
                 listElement.innerHTML = `
                    <div class="bg-white p-5 text-center rounded-xl shadow-card">
                        <i class="fas fa-tools text-4xl text-gray-300"></i>
                        <p class="mt-3 text-gray-500">No maintenance records for this unit.</p>
                    </div>
                `;
                return;
            } else if (records.length === 0) {
                // If loading is still active, just return (handled by the loading spinner)
                return;
            }

            listElement.innerHTML = records.map(record => `
                <div class="bg-white p-4 rounded-xl shadow-card border-l-4 border-yellow-500">
                    <div class="flex justify-between items-center mb-1">
                        <p class="text-base font-semibold text-gray-800">${record.problem}</p>
                        <span class="px-2 py-1 text-xs font-bold text-white rounded-full ${getMaintenanceStatusColor(record.status)}">
                            ${record.status}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 line-clamp-2">${record.description}</p>
                    <p class="text-xs text-gray-400 mt-2">
                        <i class="fas fa-clock mr-1"></i> ${new Date(record.datetime).toLocaleDateString()}
                    </p>
                </div>
            `).join('');
        }

        function renderQualityList() {
            const listElement = document.getElementById('qualityList');
            // Show newest records first
            const records = qualityData.slice().reverse();

            if (records.length === 0) {
                listElement.innerHTML = `
                    <div class="bg-white p-5 text-center rounded-xl shadow-card">
                        <i class="fas fa-tint text-4xl text-gray-300"></i>
                        <p class="mt-3 text-gray-500">No quality data available.</p>
                    </div>
                `;
                return;
            }

            listElement.innerHTML = records.map(record => {
                const { status, color } = getTDSStatus(record.tds);
                return `
                    <div class="bg-white p-4 rounded-xl shadow-card">
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-lg font-bold text-gray-800">${record.tds} ppm</p>
                            <span class="px-3 py-1 text-xs font-bold text-white rounded-full ${color}">
                                ${status}
                            </span>
                        </div>
                        <p class="text-xs text-gray-500">
                            <i class="fas fa-calendar-alt mr-1"></i> ${new Date(record.date_time).toLocaleString()}
                        </p>
                    </div>
                `;
            }).join('');
        }

        function renderAll() {
            document.getElementById('subtitle').textContent = `Unit #${unitId}`;
            renderChart();
            renderQualityList();
        }

        // --- Event Handlers & Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            getQueryParams();
            
            // Set up event listeners for date filtering
            document.querySelectorAll('.filter-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const newFilter = e.currentTarget.getAttribute('data-filter');
                    
                    // Update active button styling
                    document.querySelectorAll('.filter-button').forEach(btn => {
                        btn.classList.remove('bg-blue-500', 'text-white');
                        btn.classList.add('text-gray-600', 'hover:bg-gray-100');
                    });
                    e.currentTarget.classList.add('bg-blue-500', 'text-white');
                    e.currentTarget.classList.remove('text-gray-600', 'hover:bg-gray-100');
                    
                    dateFilter = newFilter;
                    renderChart(); 
                });
            });

            // Initial Data Load
            loadWaterQuality();
            loadMaintenanceRecords();
        });
    </script>
</body>
</html>